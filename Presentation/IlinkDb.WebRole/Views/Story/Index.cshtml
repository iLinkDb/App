@using IlinkDb.Entity

@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Stories</title>
    @Styles.Render("~/Content/css")
    @Styles.Render("~/Content/bootstrap")
    <style type="text/css">
        /*Overwrite Bootstraps dark modal.*/
        .modal-backdrop {
            opacity: 0.4;
        }
    </style>
    <link href="~/Content/siteNotes.css" rel="stylesheet" />

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")

    @Scripts.Render("~/bundles/modernizr")
    <script type='text/javascript' src="~/Scripts/knockout-2.2.1.debug.js"></script>
    <script type='text/javascript' src="~/Scripts/AppMain.js"></script>

    @Scripts.Render("~/bundles/jqueryval")

</head>
<body>
    <div class="hero-unit">
        <div class="row">
            <div class="span2">
            </div>
            <div class="span4">
                <table id="stories" class="table table-striped table-hover table-condensed">
                    <thead>
                        <tr>
                            <td>&nbsp;</td>
                            <td>Id</td>
                            <td>Name</td>
                            <td>&nbsp;</td>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach: storyViewModel.itemList">
                        <tr>
                            <td width="20px">
                                <a href="#modalEdit" data-bind="click: function (form) { editItem() }" data-toggle="modal" class='icon-pencil'></a>
                            </td>
                            <td data-bind="text: id"></td>
                            <td class="item" data-bind="text: name"></td>
                            <td width="20px">
                                <a href="#modalDelete" data-bind="click: function (form) { deleteItem() }" data-toggle="modal" class='icon-remove'></a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pull-right">
                    <a id="modalAdd" class="btn btn-success" data-toggle="modal" href="#modalEdit">Add Tenant</a>
                </div>
            </div>
            <div class="span6">
            </div>
        </div>
    </div>
</body>
</html>
<script type='text/javascript'>
    var restHost = 'localhost:30441';
    var controller = 'story';

    function story(item) {
        this.id = ko.observable(item.id);
        this.name = ko.observable(item.name);
        this.description = ko.observable(item.description);
        this.estimate = ko.observable(item.estimate);

        this.updateItem = function (item) {
            this.id(item.id);
            this.name(item.name);
        };

        this.editItem = function () {
            var form = $('#frmEdit');
            form.data('story', this);
        };

        this.deleteItem = function () {
            var form = $('#frmDelete');
            form.data('story', this);
        };
    }

    var storyViewModel = {
        itemList: ko.observableArray([]),

        loadItemList: function () {
            var self = this;
            $.getJSON('http://' + restHost + '/' + controller + '/list?projectid=830205',
                function (itemList) {
                    self.itemList.removeAll();
                    $.each(itemList, function (index, item) {
                        self.itemList.push(new story(item));
                    });
                }
            );
        }
    };

    $(function () {
        ko.applyBindings(storyViewModel);
        storyViewModel.loadItemList();

        am.initModal('modalEdit');
        am.initModal('modalDelete');

    });

</script>

@{ Html.RenderPartial("Edit", new Story()); }

